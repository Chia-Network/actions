name: Build Docker Image

on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        default: "ubuntu-latest"
      timeout-minutes:
        required: false
        type: number
        default: 360
      docker-platforms:
        required: false
        type: string
        default: "linux/amd64,linux/arm64"
      docker-context:
        required: false
        type: string
        default: .
      dockerfile:
        required: false
        type: string
        default: "./Dockerfile"
      image_subpath:
        required: false
        type: string
      dockerhub_imagename:
        required: false
        type: string
        default: ""
      build-args:
        required: false
        type: string
        default: ""
      additional-tag:
        required: false
        type: string
        default: ""
      alternate-latest-mode:
        required: false
        type: boolean
        default: false
      push:
        required: false
        type: boolean
        default: true
        description: "Whether or not to attempt to push the image to the registry"
      artifacts-name:
        required: false
        type: string
        description: "Whether artifacts should be downloaded before building the image"
      artifacts-path:
        required: false
        type: string
        description: "Path to place artifacts, if downloading"
      enable-cache:
        required: false
        type: string
        default: "false"
        description: Should the builds use docker cache
      enable-qemu-cache:
        required: false
        type: string
        default: "true"
        description: "Cache binfmt image to GitHub Actions cache backend"
      report-image-size:
        required: false
        type: string
        default: "false"
        description: "Setting this to true opts you into reporting the image size of built images, per-platform. This can greatly increase job times."
    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_PAT:
        required: false

jobs:
  package:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          cache-image: ${{ inputs.enable-qemu-cache }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Login to DockerHub
        env:
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_pat: ${{ secrets.DOCKERHUB_PAT }}
        if: ${{ env.dockerhub_username != '' && env.dockerhub_pat != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ env.dockerhub_username }}
          password: ${{ env.dockerhub_pat }}

      - name: Set image name
        id: image
        shell: bash
        run: |
          export subpath="${{ inputs.image_subpath }}"
          if [ "$subpath" == '' ]; then
            echo "imagename=ghcr.io/${{ github.repository }}" >> "$GITHUB_OUTPUT"
          else
            echo "imagename=ghcr.io/${{ github.repository }}/${subpath}" >> "$GITHUB_OUTPUT"
          fi

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ steps.image.outputs.imagename }}
            ${{ inputs.dockerhub_imagename }}
          flavor: |
            latest=auto
            prefix=
            suffix=
          tags: |
            type=raw,value=main,enable={{is_default_branch}}
            type=raw,value=latest,enable=${{ inputs.alternate-latest-mode && endsWith(github.ref, github.event.repository.default_branch) }}
            type=raw,value=${{ inputs.additional-tag }},enable=${{ inputs.additional-tag != '' }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,format=long

      - name: Download artifacts if set
        if: ${{ inputs.artifacts-name != '' && inputs.artifacts-path != '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifacts-name }}
          path: ${{ inputs.artifacts-path }}

      - name: Build Docker Container
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.docker-platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: ${{ inputs.build-args }}
          cache-from: ${{ inputs.enable-cache == 'true' && format('type=registry,ref={0}:cache', steps.image.outputs.imagename) || '' }}
          cache-to: ${{ inputs.enable-cache == 'true' && format('type=registry,ref={0}:cache,mode=max,compression=zstd', steps.image.outputs.imagename) || '' }}

      - name: Report image sizes
        if: ${{ inputs.report-image-size == 'true' }}
        shell: bash
        run: |
          echo "## üì¶ Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get the image name from the meta step
          IMAGE_NAME="${{ steps.image.outputs.imagename }}"
          echo "Image: \`$IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Construct image reference using SHA tag (format: sha-<commit-sha>)
          IMAGE_REF="${IMAGE_NAME}:sha-${{ github.sha }}"

          # Try to install jq if not present
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found, attempting to install..."
            ( command -v apk && apk add jq ) || true
            ( command -v apt-get && apt-get update && apt-get install -y jq ) || true
          fi

          # Check if jq is available after installation attempts
          if ! command -v jq >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  jq is not available and could not be installed. Skipping image size reporting." >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è  jq is not available and could not be installed. Skipping image size reporting."
            exit 0
          fi

          # Parse platforms
          IFS=',' read -ra PLATFORMS <<< "${{ inputs.docker-platforms }}"

          echo "| Architecture | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------|" >> $GITHUB_STEP_SUMMARY

          # Inspect the local multi-arch image manifest
          # This gets all architectures without rebuilding
          INSPECT_OUTPUT=$(docker manifest inspect "$IMAGE_REF" 2>/dev/null || echo "")

          if [ -z "$INSPECT_OUTPUT" ]; then
            echo "| *All* | ‚ö†Ô∏è  Failed to inspect image manifest |" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è  Failed to inspect image manifest: $IMAGE_REF"
          else
            # Debug: dump the manifest JSON structure
            echo "=== DEBUG: Manifest JSON Structure ==="
            echo "$INSPECT_OUTPUT" | jq '.' 2>&1 || echo "$INSPECT_OUTPUT"
            echo ""
            echo "=== DEBUG: Available platforms in manifest ==="
            echo "$INSPECT_OUTPUT" | jq -r '.manifests[]? | "\(.platform.os)/\(.platform.architecture) - size: \(.size // "N/A")"' 2>&1 || echo "Could not parse platforms"
            echo ""
            # Parse each platform and extract size from inspect output
            for platform in "${PLATFORMS[@]}"; do
              # Clean up platform string (remove spaces)
              platform=$(echo "$platform" | xargs)
              
              # Extract OS and Arch from platform (e.g., "linux/amd64" -> os="linux", arch="amd64")
              IFS='/' read -ra PLATFORM_PARTS <<< "$platform"
              PLATFORM_OS="${PLATFORM_PARTS[0]}"
              PLATFORM_ARCH="${PLATFORM_PARTS[1]}"

              echo "Getting size for $platform..."
              echo "DEBUG: Looking for platform os=$PLATFORM_OS arch=$PLATFORM_ARCH"

              # Get the digest for this platform
              DIGEST=$(echo "$INSPECT_OUTPUT" | jq -r --arg os "$PLATFORM_OS" --arg arch "$PLATFORM_ARCH" '
                .manifests[] | select(.platform.os == $os and .platform.architecture == $arch) | .digest // empty
              ' 2>/dev/null || echo "")
              
              echo "DEBUG: Found digest: '$DIGEST' for platform $platform"
              
              # Get size for this platform
              if [ -n "$DIGEST" ] && [ "$DIGEST" != "null" ]; then
                echo "DEBUG: Found digest: $DIGEST for platform $platform"
                
                # Inspect the manifest using the digest
                MANIFEST_JSON=$(docker manifest inspect "${IMAGE_NAME}@${DIGEST}" 2>&1)
                if [ $? -eq 0 ] && [ -n "$MANIFEST_JSON" ]; then
                  # Sum up all layer sizes plus config size
                  size=$(echo "$MANIFEST_JSON" | jq -r '[.layers[]?.size // 0, .config.size // 0] | add' 2>/dev/null || echo "")
                  echo "DEBUG: Calculated size from manifest: '$size'"
                else
                  echo "DEBUG: Failed to inspect manifest"
                  size=""
                fi
              else
                size=""
                echo "DEBUG: Could not find digest for platform"
              fi

              if [ -n "$size" ] && [ "$size" != "null" ] && [ "$size" != "0" ]; then
                size_mb=$((size / 1024 / 1024))
                size_gb=$((size_mb / 1024))

                if [ $size_gb -gt 0 ]; then
                  size_display="${size_gb}.$(( (size_mb % 1024) * 100 / 1024 ))GB"
                else
                  size_display="${size_mb}MB"
                fi

                echo "| \`$platform\` | \`$size_display\` |" >> $GITHUB_STEP_SUMMARY
                echo "‚úÖ $platform: $size_display"
              else
                echo "| \`$platform\` | ‚ö†Ô∏è  Size unavailable |" >> $GITHUB_STEP_SUMMARY
                echo "‚ö†Ô∏è  $platform: Could not extract size from manifest"
              fi
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° *Sizes shown are for uncompressed images. Registry sizes may be smaller due to compression.*" >> $GITHUB_STEP_SUMMARY
