name: "Build Docker Image"
description: "Builds a Docker image"
inputs:
  docker-platforms:
    description: "The OS/arch platforms to pass to docker buildx"
    required: false
    default: "linux/amd64,linux/arm64"
  docker-context:
    description: "The docker build context directory"
    required: false
    default: .
  dockerfile:
    description: "The path to a Dockerfile"
    required: false
    default: "./Dockerfile"
  image_subpath:
    description: "Set this to a string sub-path to publish your image under"
    required: false
  build-args:
    description: "Sets some docker build args"
    required: false
    default: ""
  additional-tag:
    description: "Set this to another tag name you'd like to publish"
    required: false
    default: ""
  alternate-latest-mode:
    description: "This creates a :latest tag on the default branch if set to true"
    required: false
    default: "false"
  push:
    description: "Whether or not to attempt to push the image to the registry"
    required: false
    default: "true"
  enable-cache:
    description: "Should the builds use docker cache"
    required: false
    default: "false"
  enable-qemu-cache:
    required: false
    type: string
    default: "true"
    description: "Cache binfmt image to GitHub Actions cache backend"
  dockerhub_imagename:
    description: ""
    required: false
    default: ""
  docker-hub-username:
    description: "An optional username to Docker Hub to authenticate as"
    required: false
  docker-hub-pat:
    description: "An optional personal access token to Docker Hub to authenticate as"
    required: false
  report-image-size:
    required: false
    type: boolean
    default: false
    description: "Setting this to true opts you into reporting the image size of built images, per-platform. This can greatly increase job times."
runs:
  using: "composite"
  steps:
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        cache-image: ${{ inputs.enable-qemu-cache }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3.11.1

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Login to DockerHub
      env:
        dockerhub_username: ${{ inputs.docker-hub-username }}
        dockerhub_pat: ${{ inputs.docker-hub-pat }}
      if: ${{ env.dockerhub_username != '' && env.dockerhub_pat != '' }}
      uses: docker/login-action@v3
      with:
        username: ${{ env.dockerhub_username }}
        password: ${{ env.dockerhub_pat }}

    - name: Set image name
      id: image
      shell: bash
      run: |
        export subpath="${{ inputs.image_subpath }}"
        if [ "$subpath" == '' ]; then
          echo "imagename=ghcr.io/${{ github.repository }}" >> "$GITHUB_OUTPUT"
        else
          echo "imagename=ghcr.io/${{ github.repository }}/${subpath}" >> "$GITHUB_OUTPUT"
        fi

    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ steps.image.outputs.imagename }}
          ${{ inputs.dockerhub_imagename }}
        flavor: |
          latest=auto
          prefix=
          suffix=
        tags: |
          type=raw,value=main,enable={{is_default_branch}}
          type=raw,value=latest,enable=${{ inputs.alternate-latest-mode && endsWith(github.ref, github.event.repository.default_branch) }}
          type=raw,value=${{ inputs.additional-tag }},enable=${{ inputs.additional-tag != '' }}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,format=long

    - name: Build Docker Container
      uses: docker/build-push-action@v6
      with:
        context: ${{ inputs.docker-context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.docker-platforms }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        build-args: ${{ inputs.build-args }}
        cache-from: ${{ inputs.enable-cache == 'true' && format('type=registry,ref={0}:cache', steps.image.outputs.imagename) || '' }}
        cache-to: ${{ inputs.enable-cache == 'true' && format('type=registry,ref={0}:cache,mode=max,compression=zstd', steps.image.outputs.imagename) || '' }}

    - name: Report image sizes
      if: ${{ inputs.report-image-size == 'true' }}
      shell: bash
      run: |
        echo "## ðŸ“¦ Docker Image Sizes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Get the image name from the meta step
        IMAGE_NAME="${{ steps.image.outputs.imagename }}"
        echo "Image: \`$IMAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Parse platforms and get image sizes for each architecture
        IFS=',' read -ra PLATFORMS <<< "${{ inputs.docker-platforms }}"

        echo "| Architecture | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|--------------|------|" >> $GITHUB_STEP_SUMMARY

        for platform in "${PLATFORMS[@]}"; do
          # Clean up platform string (remove spaces)
          platform=$(echo "$platform" | xargs)

          echo "Getting size for $platform..."
          if docker buildx build \
            --platform "$platform" \
            --load \
            --tag "temp-${platform//\//-}" \
            --cache-from type=local,src=docker-cache \
            --file "${{ inputs.dockerfile }}" \
            "${{ inputs.docker-context }}" >/dev/null 2>&1; then

            # Get image size
            if docker image inspect "temp-${platform//\//-}" >/dev/null 2>&1; then
              size=$(docker image inspect "temp-${platform//\//-}" --format='{{.Size}}')
              size_mb=$((size / 1024 / 1024))
              size_gb=$((size_mb / 1024))

              if [ $size_gb -gt 0 ]; then
                size_display="${size_gb}.$(( (size_mb % 1024) * 100 / 1024 ))GB"
              else
                size_display="${size_mb}MB"
              fi

              echo "| \`$platform\` | \`$size_display\` |" >> $GITHUB_STEP_SUMMARY
              echo "âœ… $platform: $size_display"

              # Clean up the temporary image
              docker rmi "temp-${platform//\//-}" >/dev/null 2>&1 || true
            else
              echo "| \`$platform\` | âŒ Failed to inspect |" >> $GITHUB_STEP_SUMMARY
              echo "âŒ $platform: Failed to inspect image"
            fi
          else
            echo "| \`$platform\` | âš ï¸  Build failed |" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  $platform: Failed to build/load image"
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ *Sizes shown are for uncompressed images. Registry sizes may be smaller due to compression.*" >> $GITHUB_STEP_SUMMARY
